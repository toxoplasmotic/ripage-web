<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-shared-styles.html">
<link rel="import" href="shared-styles.html">

<dom-module id="rpg-characters">

  <style include="shared-styles">
    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>

  <template>

  <style>
    .character a:hover, a:visited, a:link, a:active
    {
      color:inherit;
      text-decoration: none;
    }
  </style>

    <!-- Make a request to the Sheets API to get the tab names from the master spreadsheet -->
    <iron-ajax
      auto
      handle-as="json"
      on-response="handleSheetsResponse"
      params='{"key": "AIzaSyAUxuo3imQctu6qWm1IY4LB3VyLIj0xcpo"}'
      url="https://sheets.googleapis.com/v4/spreadsheets/1oZv1ZsaSjXGjZfpGGY0UbZ6ZF5Tb65yDuN2UIB3vo5o"></iron-ajax>

    <!-- Using the tab names, use Sheets API to get character names and player email addresses -->
    <iron-ajax
      id="charactersAjax"
      handle-as="json"
      on-response="handleCharactersResponse"
      url="https://sheets.googleapis.com/v4/spreadsheets/1oZv1ZsaSjXGjZfpGGY0UbZ6ZF5Tb65yDuN2UIB3vo5o/values:batchGet"></iron-ajax>

    <!-- Get character portraits from Google Drive API -->
    <iron-ajax
      id="portraitsAjax"
      handle-as="json"
      on-response="handlePortraitsResponse"
      url="https://www.googleapis.com/drive/v3/files?q=%270B-g6W4lSp4lKQk9KeE9rcG8wYVU%27%20in%20parents%20and%20name%20contains%20%27.jpg%27&key=AIzaSyAUxuo3imQctu6qWm1IY4LB3VyLIj0xcpo"></iron-ajax>
    
      <div class="character">
        <template is="dom-repeat" items="[[characters]]" as="character">
          <a href="/characters/[[character.characterName]]" tabindex="-1">
            <paper-icon-item>
              <div class="avatar" slot="item-icon">
                <img class="character-portrait" onerror="this.src = 'https://drive.google.com/uc?id=0B-g6W4lSp4lKMTNLZ0dVd2gzTjA';" style="width: 45px; border-radius: 50%; margin-top: 8px;" src="[[character.portraitURL]]" />
              </div>
              <paper-item-body two-line>
                <div>[[character.characterName]]</div>
                <div secondary>[[character.race]], [[character.job]] <template is="dom-if" if="[[character.isUser]]">(this is you)</template></div>
              </paper-item-body>
            </paper-icon-item>
          </a>
        </template>
      </div>

  </template>

  <script>
    class RPGCharacters extends Polymer.Element {
      static get is() { return 'rpg-characters'; }

      static get properties() {
        return {
          characters: Array,
          user: Object
        };
      }

      handleSheetsResponse(data){
        var sheetTitles = data.detail.response.sheets.map(sheet => sheet.properties.title);
        var params = { 
          "key": "AIzaSyAUxuo3imQctu6qWm1IY4LB3VyLIj0xcpo",
          "valueRenderOption": "FORMULA",
          "ranges": sheetTitles.map(title => "'" + title + "'!A1:F3")
        };

        this.$.charactersAjax.params = params;
        this.$.charactersAjax.generateRequest();
      }

      handleCharactersResponse(data){
        var that = this;
        that.characters = [];

        data.detail.response.valueRanges.forEach((item) => {
          if (item.values[0][0] === "Character:" && item.values[0][1].length > 0)
          {// valid character
            var hyperlink = item.values[0][1];
            var playerEmail = hyperlink.split('"')[1];
            var character = {};

            if (playerEmail)
            {
                character.playerEmail = playerEmail.substring(7);
                character.characterName = hyperlink.split('"')[3];
                character.isUser = (that.user.email === playerEmail.substring(7));
                console.dir(character);
            }
            else
            {
                character.characterName = hyperlink;
                character.isNPC = true;
            }

            character.race = item.values[1][1];
            character.job = item.values[2][3];

            that.characters.push(character);
          }
        });

         var portraitsResponse = {
          "kind": "drive#fileList",
          "incompleteSearch": false,
          "files": [
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKdmFjN01Va0RCeEk",
            "name": "Angeleigh.jpg",
            "mimeType": "image/jpeg"
            },
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKb3hKWTlKd3QxQjg",
            "name": "Kujo.jpg",
            "mimeType": "image/jpeg"
            },
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKb0NFaWtUX1ZNT0k",
            "name": "Tex.jpg",
            "mimeType": "image/jpeg"
            },
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKa0RuQmU4bWdTaGc",
            "name": "Mokomi.jpg",
            "mimeType": "image/jpeg"
            },
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKakpKMTNNdGZhYTA",
            "name": "Kalder.jpg",
            "mimeType": "image/jpeg"
            },
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKYlMwVjMwTFpRek0",
            "name": "Jim.jpg",
            "mimeType": "image/jpeg"
            },
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKWk9OdE94YnFydE0",
            "name": "Gizmo.jpg",
            "mimeType": "image/jpeg"
            },
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKUVNSVFluSFlBMVk",
            "name": "Sofi.jpg",
            "mimeType": "image/jpeg"
            },
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKMW9vWTZ3dWxzVEU",
            "name": "Malzith.jpg",
            "mimeType": "image/jpeg"
            },
            {
            "kind": "drive#file",
            "id": "0B-g6W4lSp4lKUVhucmdVZHRESUU",
            "name": "Jax.jpg",
            "mimeType": "image/jpeg"
            }
          ]
          };

          portraitsResponse.files.forEach(function(file) {
            var character = that.characters.find(x => x.characterName === file.name.split('.')[0]);
            if (character)
            {
              character.portraitURL = "https://drive.google.com/uc?id=" + file.id;
            }
          });

      }

      handlePortraitsResponse(data){
        var that = this;
        data.detail.response.files.forEach(function(file) {
          var character = that.characters.find(x => x.characterName === file.name.split('.')[0]);
          if (character)
          {
            character.portraitURL = "https://drive.google.com/uc?id=" + file.id;
          }
        });
      }
    }

    window.customElements.define(RPGCharacters.is, RPGCharacters);
  </script>
</dom-module>